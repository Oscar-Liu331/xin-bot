<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¿ƒå¿«æ´» èŠå¤©æ¨è–¦å°å¹«æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif;
    }

    body {
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
    }

    .chat-wrapper {
      width: 100%;
      max-width: 800px;
      height: 80vh;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 14px 18px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: #ffffff;
    }

    .chat-header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .chat-header-status {
      font-size: 12px;
      opacity: 0.9;
    }

    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f9fafb;
    }

    .message-row {
      display: flex;
      margin-bottom: 10px;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-row.bot {
      justify-content: flex-start;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .message-row.user .avatar {
      margin-right: 0;
      margin-left: 8px;
      background: #4f46e5;
      color: #ffffff;
    }

    .message-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
    }

    .message-row.bot .message-bubble {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-top-left-radius: 4px;
    }

    .message-row.user .message-bubble {
      background: #4f46e5;
      color: #ffffff;
      border: 1px solid #4338ca;
      border-top-right-radius: 4px;
    }

    .message-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .message-row.user .message-meta {
      text-align: right;
    }

    .chat-input-area {
      padding: 10px 12px;
      border-top: 1px solid #e5e7eb;
      background: #ffffff;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chat-input {
      width: 100%;
      min-height: 40px;
      max-height: 120px;
      resize: none;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .chat-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    .chat-input-hint {
      font-size: 11px;
      color: #9ca3af;
    }

    .send-btn {
      border: none;
      outline: none;
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
      background: #4f46e5;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.05s;
      flex-shrink: 0;
    }

    .send-btn:active {
      transform: scale(0.97);
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .send-btn-icon {
      font-size: 14px;
    }

    @media (max-width: 600px) {
      .chat-wrapper {
        height: 90vh;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-header">
      <div>
        <div class="chat-header-title">å¿ƒå¿«æ´» èª²ç¨‹æ¨è–¦ & å¿ƒæ“šé»æŸ¥è©¢</div>
        <div class="chat-header-status">ğŸŸ¢ å·²é€£ç·š API /chat</div>
      </div>
    </div>

    <div id="chatMessages" class="chat-messages">
      <!-- æ­·å²è¨Šæ¯ / æ–°è¨Šæ¯éƒ½æœƒå¡åœ¨é€™ -->
    </div>

    <div class="chat-input-area">
      <div class="chat-input-box">
        <textarea
          id="chatInput"
          class="chat-input"
          rows="1"
          placeholder="è¼¸å…¥æƒ³å•çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šå°å­©å¸¸å¸¸æƒ…ç·’å¤±æ§æ€éº¼è¾¦ï¼Ÿ æˆ– å°å—å¸‚æ±å€å¤§å­¸è·¯1è™Ÿé™„è¿‘æœ‰æ²’æœ‰å¿ƒæ“šé»ï¼Ÿ"
        ></textarea>
        <div class="chat-input-hint">Enterï¼šé€å‡ºã€€Shift+Enterï¼šæ›è¡Œ</div>
      </div>
      <button id="sendBtn" class="send-btn">
        <span class="send-btn-icon">â¤</span>
        é€å‡º
      </button>
    </div>
  </div>

  <script>
    const chatMessagesEl = document.getElementById('chatMessages');
    const chatInputEl = document.getElementById('chatInput');
    const sendBtnEl = document.getElementById('sendBtn');

    // å¦‚æœ HTML ä¸æ˜¯è·Ÿ API åŒç¶²åŸŸï¼Œé€™é‚Šå¯ä»¥æ”¹æˆ 'http://localhost:8000'
    const API_BASE = '';

    // å–å¾—ç¾åœ¨æ™‚é–“å­—ä¸² HH:MM
    function getTimeString() {
      const d = new Date();
      const hh = d.getHours().toString().padStart(2, '0');
      const mm = d.getMinutes().toString().padStart(2, '0');
      return `${hh}:${mm}`;
    }

    // å»ºç«‹ä¸€å‰‡è¨Šæ¯ DOM
    function appendMessage(role, text) {
      const row = document.createElement('div');
      row.classList.add('message-row', role);

      const avatar = document.createElement('div');
      avatar.classList.add('avatar');
      avatar.textContent = role === 'user' ? 'æˆ‘' : 'å¿ƒ';

      const bubbleWrap = document.createElement('div');
      const bubble = document.createElement('div');
      bubble.classList.add('message-bubble');
      bubble.textContent = text;

      const meta = document.createElement('div');
      meta.classList.add('message-meta');
      meta.textContent = getTimeString();

      bubbleWrap.appendChild(bubble);
      bubbleWrap.appendChild(meta);

      if (role === 'bot') {
        row.appendChild(avatar);
        row.appendChild(bubbleWrap);
      } else {
        row.appendChild(bubbleWrap);
        row.appendChild(avatar);
      }

      chatMessagesEl.appendChild(row);

      // è‡ªå‹•æ²åˆ°åº•
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    // æŠŠ API å›å‚³çš„ JSON è½‰æˆèŠå¤©æ¡†è£¡çš„æ–‡å­—
    function formatApiResponse(resp) {
      if (!resp || typeof resp !== 'object') {
        return 'ï¼ˆç³»çµ±æ²’æœ‰å›å‚³å¯é¡¯ç¤ºçš„è³‡è¨Šï¼‰';
      }

      if (resp.type === 'xin_points') {
        const addr = resp.address || 'ï¼ˆæœªæŒ‡å®šåœ°å€ï¼‰';
        const points = resp.points || [];
        let lines = [];

        if (points.length === 0) {
          if (resp.message) {
            lines.push(resp.message);
          } else {
            lines.push(`åœ¨ã€Œ${addr}ã€é™„è¿‘ç›®å‰æ‰¾ä¸åˆ°å¿ƒæ“šé»ã€‚`);
          }
        } else {
          lines.push(`åœ¨ã€Œ${addr}ã€5 å…¬é‡Œå…§æ‰¾åˆ°é€™äº›å¿ƒæ“šé»ï¼š`);
          points.forEach((p, idx) => {
            lines.push(`\n${idx + 1}. ${p.title || '(æœªå‘½åæ“šé»)'}ï¼ˆç´„ ${p.distance_km} å…¬é‡Œï¼‰`);
            if (p.address) {
              lines.push(`   åœ°å€ï¼š${p.address}`);
            }
            if (p.tel) {
              lines.push(`   é›»è©±ï¼š${p.tel}`);
            }
          });
        }

        return lines.join('\n');
      }

      if (resp.type === 'course_recommendation') {
        const results = resp.results || [];
        let lines = [];

        if (results.length === 0) {
          lines.push(resp.message || 'ç›®å‰æ‰¾ä¸åˆ°å¾ˆç¬¦åˆçš„èª²ç¨‹ï¼Œå¯ä»¥æ›å€‹é—œéµå­—å†è©¦è©¦ã€‚');
        } else {
          lines.push('æ ¹æ“šä½ çš„æ•˜è¿°ï¼Œæˆ‘å¹«ä½ æ‰¾äº†é€™äº›èª²ç¨‹ / æ–‡ç« ï¼š');
          results.forEach((item, idx) => {
            const sec = item.section_title || '';
            const title = item.title || '(ç„¡æ¨™é¡Œ)';
            lines.push(`\n${idx + 1}. ${sec ? 'ã€' + sec + 'ã€‘' : ''}${title}`);

            if (item.type === 'video') {
              if (item.youtube_url) {
                lines.push(`   å½±ç‰‡é€£çµï¼š${item.youtube_url}`);
              }
              if (item.hint) {
                lines.push(`   å°æé†’ï¼š${item.hint}`);
              }
            } else if (item.type === 'article') {
              if (item.article_url) {
                lines.push(`   æ–‡ç« é€£çµï¼š${item.article_url}`);
              }
              if (item.snippet) {
                lines.push(`   ç¯€éŒ„ï¼š${item.snippet}`);
              }
            }
          });
        }

        return lines.join('\n');
      }

      // fallbackï¼šä¸èªè­˜çš„ typeï¼Œå°±ç›´æ¥æŠŠ JSON stringify ä¸€ä¸‹
      return 'ç³»çµ±å›æ‡‰ï¼š\n' + JSON.stringify(resp, null, 2);
    }

    async function callChatApi(query) {
      const res = await fetch(`${API_BASE}/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query }),
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      return await res.json();
    }

    async function loadHistory() {
      try {
        const res = await fetch(`${API_BASE}/history`);
        if (!res.ok) {
          console.warn('è¼‰å…¥æ­·å²å¤±æ•—ï¼š', res.status);
          return;
        }
        const data = await res.json();
        const items = data.items || [];

        // ä¾åºæŠŠæ­·å²ç´€éŒ„ç•«å‡ºä¾†
        for (const item of items) {
          if (item.query) {
            appendMessage('user', item.query);
          }
          if (item.response) {
            const botText = formatApiResponse(item.response);
            appendMessage('bot', botText);
          }
        }
      } catch (err) {
        console.error('è¼‰å…¥æ­·å²éŒ¯èª¤ï¼š', err);
      }
    }

    async function sendMessage() {
      const text = chatInputEl.value.trim();
      if (!text) return;

      appendMessage('user', text);
      chatInputEl.value = '';
      chatInputEl.focus();
      autoResizeTextarea();

      sendBtnEl.disabled = true;

      try {
        const resp = await callChatApi(text);
        const botText = formatApiResponse(resp);
        appendMessage('bot', botText);
      } catch (err) {
        console.error(err);
        appendMessage('bot', 'å‘¼å«å¾Œç«¯ API å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      } finally {
        sendBtnEl.disabled = false;
      }
    }

    function autoResizeTextarea() {
      chatInputEl.style.height = 'auto';
      chatInputEl.style.height = chatInputEl.scrollHeight + 'px';
    }

    // äº‹ä»¶ç¶å®š
    sendBtnEl.addEventListener('click', sendMessage);

    chatInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    chatInputEl.addEventListener('input', autoResizeTextarea);

    // åˆå§‹åŒ–ï¼šå…ˆè¼‰å…¥æ­·å²ï¼Œå†è£œä¸€å‰‡æ­¡è¿è¨Šæ¯ï¼ˆå¦‚æœå®Œå…¨æ²’æœ‰ç´€éŒ„ï¼‰
    async function initChat() {
      await loadHistory();

      if (chatMessagesEl.children.length === 0) {
        appendMessage(
          'bot',
          'å—¨ï½æˆ‘æ˜¯å¿ƒå¿«æ´»å°å¹«æ‰‹ ğŸ˜Š\n\nä½ å¯ä»¥å•æˆ‘ï¼š\nâ€¢ å°å­©ã€æƒ…ç·’ã€ç„¦æ…®ã€å¤±çœ ç­‰å›°æ“¾ï¼Œå¹«ä½ æ¨è–¦å½±ç‰‡å’Œæ–‡ç« \nâ€¢ è¼¸å…¥åœ°å€æˆ–ã€Œå°å—å¸‚æ±å€å¤§å­¸è·¯1è™Ÿé™„è¿‘æœ‰æ²’æœ‰å¿ƒæ“šé»ï¼Ÿã€å¹«ä½ æ‰¾é™„è¿‘å¿ƒæ“šé»'
        );
      }

      chatInputEl.focus();
    }

    initChat();
  </script>
</body>
</html>
