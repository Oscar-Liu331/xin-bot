<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¿ƒå¿«æ´» èŠå¤©æ¨è–¦å°å¹«æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    .message-bubble a {
      color: #2563eb;
      text-decoration: underline;
    }
    .message-row.user .message-bubble a {
      color: #ffffff;
      text-decoration: underline;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif;
    }

    body {
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
    }

    .chat-wrapper {
      width: 100%;
      max-width: 800px;
      height: 80vh;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 14px 18px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: #ffffff;
    }

    .chat-header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .chat-header-status {
      font-size: 12px;
      opacity: 0.9;
    }

    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f9fafb;
    }

    .message-row {
      display: flex;
      margin-bottom: 10px;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-row.bot {
      justify-content: flex-start;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .message-row.user .avatar {
      margin-right: 0;
      margin-left: 8px;
      background: #4f46e5;
      color: #ffffff;
    }

    .message-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message-row.bot .message-bubble {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-top-left-radius: 4px;
    }

    .message-row.user .message-bubble {
      background: #4f46e5;
      color: #ffffff;
      border: 1px solid #4338ca;
      border-top-right-radius: 4px;
    }

    .message-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .message-row.user .message-meta {
      text-align: right;
    }

    .chat-input-area {
      padding: 10px 12px;
      border-top: 1px solid #e5e7eb;
      background: #ffffff;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chat-input {
      width: 100%;
      min-height: 40px;
      max-height: 120px;
      resize: none;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .chat-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    .chat-input-hint {
      font-size: 11px;
      color: #9ca3af;
    }

    .send-btn {
      border: none;
      outline: none;
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
      background: #4f46e5;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.05s;
      flex-shrink: 0;
    }

    .send-btn:active {
      transform: scale(0.97);
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .send-btn-icon {
      font-size: 14px;
    }

    @media (max-width: 600px) {
      .chat-wrapper {
        height: 90vh;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-header">
      <div>
        <div class="chat-header-title">å¿ƒå¿«æ´» èª²ç¨‹æ¨è–¦ & å¿ƒæ“šé»æŸ¥è©¢</div>
        <div class="chat-header-status">ğŸŸ¢ å·²é€£ç·š API /chat</div>
      </div>
    </div>

    <div id="chatMessages" class="chat-messages">
      </div>

    <div class="chat-input-area">
      <div class="chat-input-box">
        <textarea
          id="chatInput"
          class="chat-input"
          rows="1"
          placeholder="è¼¸å…¥æƒ³å•çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šå°å­©å¸¸å¸¸æƒ…ç·’å¤±æ§æ€éº¼è¾¦ï¼Ÿ æˆ– å°å—å¸‚æ±å€å¤§å­¸è·¯1è™Ÿé™„è¿‘æœ‰æ²’æœ‰å¿ƒæ“šé»ï¼Ÿ"
        ></textarea>
        <div class="chat-input-hint">Enterï¼šé€å‡ºã€€Shift+Enterï¼šæ›è¡Œ</div>
      </div>
      <button id="sendBtn" class="send-btn">
        <span class="send-btn-icon">â¤</span>
        é€å‡º
      </button>
    </div>
  </div>

  <script>
    const chatMessagesEl = document.getElementById('chatMessages');
    const chatInputEl = document.getElementById('chatInput');
    const sendBtnEl = document.getElementById('sendBtn');

    const API_BASE = '';

    let SESSION_ID = localStorage.getItem('xin_session_id');

    if (!SESSION_ID) {
      if (window.crypto && crypto.randomUUID) {
        SESSION_ID = crypto.randomUUID();
      } else {
        SESSION_ID = 'sess-' + Date.now() + '-' + Math.floor(Math.random() * 1e9);
      }
      localStorage.setItem('xin_session_id', SESSION_ID);
    }

    console.log('SESSION_ID =', SESSION_ID);

    function getTimeString() {
      const d = new Date();
      const hh = d.getHours().toString().padStart(2, '0');
      const mm = d.getMinutes().toString().padStart(2, '0');
      return `${hh}:${mm}`;
    }

    function appendMessage(role, text, asHtml = false, latency = null) {
      const row = document.createElement('div');
      row.classList.add('message-row', role);

      const avatar = document.createElement('div');
      avatar.classList.add('avatar');
      avatar.textContent = role === 'user' ? 'æˆ‘' : 'å¿ƒ';

      const bubbleWrap = document.createElement('div');
      const bubble = document.createElement('div');
      bubble.classList.add('message-bubble');

      if (asHtml) {
        bubble.innerHTML = text;
      } else {
        bubble.textContent = text;
      }

      const meta = document.createElement('div');
      meta.classList.add('message-meta');
      let metaText = getTimeString();
      if (latency && role === 'bot') {
        metaText += ` Â· è€—æ™‚ ${latency}`;
      }
      meta.textContent = getTimeString();

      bubbleWrap.appendChild(bubble);
      bubbleWrap.appendChild(meta);

      if (role === 'bot') {
        row.appendChild(avatar);
        row.appendChild(bubbleWrap);
      } else {
        row.appendChild(bubbleWrap);
        row.appendChild(avatar);
      }

      chatMessagesEl.appendChild(row);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }


    function formatApiResponse(resp) {
      if (!resp || typeof resp !== 'object') {
        return 'ï¼ˆç³»çµ±æ²’æœ‰å›å‚³å¯é¡¯ç¤ºçš„è³‡è¨Šï¼‰';
      }

      if (resp.type === 'advice') {
        const lines = [];
        if (resp.title) {
          lines.push(`ã€${resp.title}ã€‘`);
          lines.push('');
        }
        (resp.sections || []).forEach((sec) => {
          if (sec.title && sec.title.trim() !== '') {
            lines.push(sec.title);
          }
          (sec.items || []).forEach((item, idx) => {
            lines.push(`  ${idx + 1}. ${item}`);
          });
          lines.push('');
        });
        return lines.join('\n');
      }

      if (resp.type === 'xin_points') {
        const addr = resp.address || 'ï¼ˆæœªæŒ‡å®šåœ°å€ï¼‰';
        const points = resp.points || [];
        let lines = [];

        if (points.length === 0) {
          if (resp.message) {
            lines.push(resp.message);
          } else {
            lines.push(`åœ¨ã€Œ${addr}ã€é™„è¿‘ç›®å‰æ‰¾ä¸åˆ°å¿ƒæ“šé»ã€‚`);
          }
        } else {
          lines.push(`åœ¨ã€Œ${addr}ã€5 å…¬é‡Œå…§æ‰¾åˆ°é€™äº›å¿ƒæ“šé»ï¼š`);
          points.forEach((p, idx) => {
            lines.push(`\n${idx + 1}. ${p.title || '(æœªå‘½åæ“šé»)'}ï¼ˆç´„ ${p.distance_km} å…¬é‡Œï¼‰`);
            if (p.address) {
              lines.push(`   åœ°å€ï¼š${p.address}`);
            }
            if (p.tel) {
              lines.push(`   é›»è©±ï¼š${p.tel}`);
            }
            if (p.map_url) {
              lines.push(`   ğŸš— <a href="${p.map_url}" target="_blank" rel="noopener noreferrer">é–‹å•Ÿå°èˆªè·¯ç·š</a>`);
            }
          });
        }
        return lines.join('\n');
      }

      if (resp.type === 'course_recommendation') {
        const lines = [];
        const results = resp.results || [];

        if (resp.header_text) {
             lines.push(resp.header_text);
        } else {
             if (resp.video_count == 0)
               lines.push(`ğŸ“š å…±æ‰¾åˆ° ${resp.total} ç­†å…§å®¹ï¼ˆğŸ“„ æ–‡ç«  ${resp.article_count}ï¼‰`);
             else if (resp.article_count == 0)
               lines.push(`ğŸ“š å…±æ‰¾åˆ° ${resp.total} ç­†å…§å®¹ï¼ˆğŸ¥ å½±ç‰‡ ${resp.video_count}ï¼‰`);
             else
               lines.push(`ğŸ“š å…±æ‰¾åˆ° ${resp.total} ç­†å…§å®¹ï¼ˆğŸ¥ å½±ç‰‡ ${resp.video_count}ã€ğŸ“„ æ–‡ç«  ${resp.article_count}ï¼‰`);
             lines.push(`ç›®å‰é¡¯ç¤ºç¬¬ ${resp.offset + 1}ï½${Math.min(resp.offset + resp.limit, resp.total)} ç­†`);
             lines.push('');
             lines.push('æ ¹æ“šä½ çš„æ•˜è¿°ï¼Œæˆ‘å¹«ä½ æ‰¾äº†é€™äº›èª²ç¨‹ / æ–‡ç« ï¼š');
        }

        if (results.length === 0) {
          lines.push(resp.message || 'ç›®å‰æ‰¾ä¸åˆ°å¾ˆç¬¦åˆçš„èª²ç¨‹ï¼Œå¯ä»¥æ›å€‹é—œéµå­—å†è©¦è©¦ã€‚');
          return lines.join('\n').replace(/\n/g, '<br>');
        }

        results.forEach((item, idx) => {
          const sec = '';
          const title = item.title || '(ç„¡æ¨™é¡Œ)';
          const kind = item.type === 'article' ? 'æ–‡ç« ' : 'å½±ç‰‡';
          
          let kindDisplay = kind;
          if (title.includes('\n')) {
               if (kind === 'æ–‡ç« ') kindDisplay = 'ğŸ“'; 
               if (kind === 'å½±ç‰‡') kindDisplay = 'ğŸ¬';
          } else {
               kindDisplay = `ã€${kind}ã€‘`;
          }
          
          let scoreHtml = '';
          if (item.score !== undefined) {
             scoreHtml = ` <span style="color: #e53e3e; font-weight: bold; font-size: 0.9em;">(â˜…${Number(item.score).toFixed(1)})</span>`;
          }

          lines.push('');
          lines.push(`${idx + 1}. ${kindDisplay}${sec ? ' ' + sec : ''} ${title}${scoreHtml}`);

          if (item.type === 'video') {
            if (item.youtube_url) {
              const label = item.link_label || "ğŸ¥ å½±ç‰‡é€£çµï¼š";
              lines.push(`   ${label}<a href="${item.youtube_url}" target="_blank" rel="noopener noreferrer">${item.youtube_url}</a>`);
            }
            if (item.hint) lines.push(`   ${item.hint}`); 
          } else if (item.type === 'article') {
            if (item.article_url) {
              const label = item.link_label || "ğŸ“„ æ–‡ç« é€£çµï¼š";
              lines.push(`   ${label}<a href="${item.article_url}" target="_blank" rel="noopener noreferrer">${item.article_url}</a>`);
            }
            if (item.snippet) lines.push(`   ğŸ§¾ ${item.snippet}`);
          }
        });

        if (resp.has_more && resp.message) {
          lines.push('');
          
          let btnText = "çµ¦æˆ‘å¾Œäº”å€‹"; 
          
          const match = resp.message.match(/ã€Œ(.+?)ã€|'(.+?)'/);
          if (match) {
              btnText = match[1] || match[2];
          } else if (resp.message.includes("Next 5")) {
              btnText = "Next 5"; 
          } else if (resp.message.includes("æ¬¡ã®5ä»¶")) {
              btnText = "æ¬¡ã®5ä»¶"; 
          }

          lines.push(`<a href="#" class="auto-send-link" data-msg="${btnText}" style="text-decoration:none; color:#4f46e5; font-weight:bold; border:1px solid #4f46e5; padding:4px 12px; border-radius:15px; display:inline-block; margin-top:8px;">${resp.message}</a>`);
        }

        return lines.join('\n').replace(/\n/g, '<br>');
      }

      return 'ç³»çµ±å›æ‡‰ï¼š\n' + JSON.stringify(resp, null, 2);
    }

    async function callChatApi(query) {
      const res = await fetch(`${API_BASE}/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query,
          session_id: SESSION_ID, 
        }),
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      return await res.json();
    }

    async function loadHistory() {
      try {
        const res = await fetch(`${API_BASE}/history?session_id=${SESSION_ID}`);
        if (!res.ok) {
          console.warn('è¼‰å…¥æ­·å²å¤±æ•—ï¼š', res.status);
          return;
        }
        const data = await res.json();
        const items = data.items || [];

        for (const item of items) {
          if (item.query) {
            appendMessage('user', item.query);
          }
          if (item.response) {
            const botHtml = formatApiResponse(item.response);
            const latency = item.response.process_time || null;
            appendMessage('bot', botHtml, true,latency); 
          }
        }
      } catch (err) {
        console.error('è¼‰å…¥æ­·å²éŒ¯èª¤ï¼š', err);
      }
    }

    async function sendMessage() {
      const text = chatInputEl.value.trim();
      if (!text) return;

      appendMessage('user', text);
      chatInputEl.value = '';
      chatInputEl.focus();
      autoResizeTextarea();

      sendBtnEl.disabled = true;

      try {
        const resp = await callChatApi(text);
        const botHtml  = formatApiResponse(resp);

        const latency = resp.process_time || null;

        appendMessage('bot', botHtml, true,latency);
      } catch (err) {
        console.error(err);
        appendMessage('bot', 'å‘¼å«å¾Œç«¯ API å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      } finally {
        sendBtnEl.disabled = false;
      }
    }

    function autoResizeTextarea() {
      chatInputEl.style.height = 'auto';
      chatInputEl.style.height = chatInputEl.scrollHeight + 'px';
    }

    sendBtnEl.addEventListener('click', sendMessage);

    chatInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    chatInputEl.addEventListener('input', autoResizeTextarea);

    async function initChat() {
      await loadHistory();

      if (chatMessagesEl.children.length === 0) {
        appendMessage(
          'bot',
          'å—¨ï½æˆ‘æ˜¯å¿ƒå¿«æ´»å°å¹«æ‰‹ ğŸ˜Š\n\nä½ å¯ä»¥å•æˆ‘ï¼š\nâ€¢ å°å­©ã€æƒ…ç·’ã€ç„¦æ…®ã€å¤±çœ ç­‰å›°æ“¾ï¼Œå¹«ä½ æ¨è–¦å½±ç‰‡å’Œæ–‡ç« \nâ€¢ è¼¸å…¥åœ°å€æˆ–ã€Œå°å—å¸‚æ±å€å¤§å­¸è·¯1è™Ÿé™„è¿‘æœ‰æ²’æœ‰å¿ƒæ“šé»ï¼Ÿã€å¹«ä½ æ‰¾é™„è¿‘å¿ƒæ“šé»'
        );
      }

      chatInputEl.focus();
    }
    chatMessagesEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('auto-send-link')) {
          e.preventDefault(); 
          
          const msg = e.target.getAttribute('data-msg');
          if (msg) {
            chatInputEl.value = msg;
            sendMessage();
          }
        }
      });
    initChat();
  </script>
</body>
</html>